# Invoice Parser & Query App (Gemini 1.5 Flash + Gradio + MySQL)

An AI-powered invoice parsing app that extracts structured data (invoice metadata, line items, totals) from **PDF/image invoices** using **Google Gemini 1.5 Flash (Vision)**, stores the results in **MySQL**, and allows **natural language queries** that are converted into SQL and executed on the stored invoice data.

---

## What this project does

### 1) Parse invoices (PDF / PNG / JPG)
- Converts PDF pages into images (PyMuPDF)
- Sends invoice images to **Gemini 1.5 Flash** with prompts for:
  - Invoice metadata (invoice number, date, seller/buyer)
  - Line items (description, quantity, unit price, line total)
  - Totals (subtotal, tax, total amount, payment method)
- Normalizes different key names (e.g., `inv_no`, `invoice_number`, etc.)
- Saves extracted items into:
  - `parsed_items.csv`
  - **MySQL table** `invoices`

### 2) Query invoices using plain English
Example questions:
- “Show me all invoice numbers”
- “What is the total amount for invoice 354-993?”
- “List items where quantity > 2”
- “How many unique source files exist?”

The app uses Gemini to generate SQL based on the schema and runs it on MySQL.

---

## Tech stack

- **Python**
- **Gradio** (UI)
- **Google Gemini 1.5 Flash** (LLM + Vision)
- **PyMuPDF (fitz)** for PDF-to-image
- **Pandas** for CSV + table display
- **MySQL** for storage
- **python-dotenv** for environment variables

---

## Project structure (important files)

- `parse.py` → Main app (parsing + DB insert + NL→SQL querying + Gradio UI)
- `requirements.txt` → Dependencies
- `.env` → API keys & MySQL credentials (not committed)
- `parsed_items.csv` → Output CSV created/appended by the parser

---

## Database schema

This is the schema used by the NL→SQL module:

```sql
CREATE TABLE invoices (
    description TEXT,
    quantity INTEGER,
    price REAL,
    total REAL,
    invoice_number VARCHAR(255),
    invoice_date VARCHAR(255),
    source_file VARCHAR(255),
    subtotal REAL,
    tax REAL,
    total_amount REAL,
    payment_method VARCHAR(255)
);


Setup instructions (step-by-step)
1) Create and activate a virtual environment

Windows (PowerShell):

python -m venv .venv
.\.venv\Scripts\Activate.ps1
2) Install dependencies
pip install -r requirements.txt
pip install mysql-connector-python

Note: mysql-connector-python is required because the code uses mysql.connector.
Add it to your requirements.txt if you want full reproducibility.

3) Create .env file

Create a file named .env in the project root:

GOOGLE_API_KEY=YOUR_KEY_HERE

MYSQL_HOST=localhost
MYSQL_USER=invoice_user
MYSQL_PASSWORD=YOUR_PASSWORD
MYSQL_DATABASE=invoice_parser
4) Create MySQL DB + user (example)

Login to MySQL and run:

CREATE DATABASE invoice_parser;

CREATE USER 'invoice_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON invoice_parser.* TO 'invoice_user'@'localhost';
FLUSH PRIVILEGES;

USE invoice_parser;

CREATE TABLE invoices (
    description TEXT,
    quantity INTEGER,
    price REAL,
    total REAL,
    invoice_number VARCHAR(255),
    invoice_date VARCHAR(255),
    source_file VARCHAR(255),
    subtotal REAL,
    tax REAL,
    total_amount REAL,
    payment_method VARCHAR(255)
);
5) Run the app
python parse.py

Gradio will start locally and show a link like:

http://127.0.0.1:7860
---------------------------------------------------------------------------------------------------------------------------------------------------------------------

How to use
Tab 1: Parse Invoices

Upload one or multiple invoice files (PDF/PNG/JPG)

Click Parse and Store

You’ll get:

Parsed JSON output in the UI

A downloadable parsed_items.csv

Records stored in MySQL

Tab 2: Natural Language SQL Query

Write a question in simple English

Click Generate SQL & Execute

The results are shown as a table
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
Example queries to try

“Show me all distinct invoice numbers”

“Show me all items from Amazoninvoice.png”

“Total amount for invoice number 354-993”

“List descriptions where quantity is greater than 1”

“What is the average price of items?”

“Show all records sorted by invoice_date”
------------------------------------------------------------------------------------------------------------------------------------------------------------

Notes / limitations

Accuracy depends on invoice quality (blur, scan quality, unusual formats).

The parser uses vision by converting PDFs to images (works better for scanned PDFs).

Natural language → SQL output is generated by an LLM. For production use, you should add:

SQL validation / safe allowlist

Read-only queries enforcement

Better error handling and logging
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Future improvements 

Add support for more invoice formats using multiple prompt strategies

Improve JSON extraction reliability with stricter parsing + retries

Add caching so the same invoice isn’t re-parsed

Add a “confidence score” / evaluation checks (totals match sum of items)

Add user authentication and multi-user invoice separation


Export results in Excel/JSON + analytics dashboard
